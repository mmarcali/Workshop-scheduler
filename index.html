<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workshop Scheduler</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .icon { width: 1rem; height: 1rem; display: inline-block; }
        .icon-lg { width: 1.5rem; height: 1.5rem; }
        .icon-xl { width: 2rem; height: 2rem; }
        .icon-2xl { width: 4rem; height: 4rem; }
        .icon-3xl { width: 5rem; height: 5rem; }
        
        .calendar-cell {
            min-height: 3rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .calendar-cell:hover {
            transform: scale(1.02);
        }
        
        .date-in-range {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        }
        
        .date-selected-by-participants {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Google Apps Script Configuration
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxVUTZA03Ct-MPVtf2BN-j7KC86xc295YXVSAgtDETXropngEQBCBbXDeDTB4uXDUFa9w/exec';

        // Icon components
        const Calendar = ({ className = "icon" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        );

        const ChevronLeft = ({ className = "icon" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="15,18 9,12 15,6"></polyline>
            </svg>
        );

        const ChevronRight = ({ className = "icon" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="9,18 15,12 9,6"></polyline>
            </svg>
        );

        const Users = ({ className = "icon" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
        );

        const Plus = ({ className = "icon" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const Trash2 = ({ className = "icon" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="3,6 5,6 21,6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );

        const CheckCircle = ({ className = "icon" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22,4 12,14.01 9,11.01"></polyline>
            </svg>
        );

        const User = ({ className = "icon" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
        );

        const Settings = ({ className = "icon" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
        );

        const Link = ({ className = "icon" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
            </svg>
        );

        const Save = ({ className = "icon" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17,21 17,13 7,13 7,21"></polyline>
                <polyline points="7,3 7,8 15,8"></polyline>
            </svg>
        );

        // Google Sheets API functions
        const saveToSheets = async (data) => {
            try {
                console.log('Attempting to save to Google Sheets:', data);
                const formData = new FormData();
                formData.append('data', JSON.stringify(data));
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                console.log('Success result:', result);
                return result;
            } catch (error) {
                console.error('Error saving to Google Sheets:', error);
                alert(`Error saving data: ${error.message}. Check the browser console for details.`);
                throw error;
            }
        };

        const loadFromSheets = async () => {
            try {
                console.log('Loading data from Google Sheets...');
                const response = await fetch(GOOGLE_SCRIPT_URL);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('Load success result:', result);
                
                // Handle both old and new data formats for backward compatibility
                const config = result.config || {};
                let dateRanges = config.dateRanges || [];
                
                // If we have old timeSlots format, convert to new dateRanges format
                if (config.timeSlots && config.timeSlots.length > 0) {
                    console.log('Converting old timeSlots format to new dateRanges format...');
                    dateRanges = config.timeSlots.map(slot => ({
                        id: slot.id,
                        startDate: slot.dateFrom,
                        endDate: slot.dateTo,
                        description: slot.description
                    }));
                }
                
                return {
                    config: {
                        description: config.description || '',
                        dateRanges: dateRanges
                    },
                    participants: result.participants || {}
                };
            } catch (error) {
                console.error('Error loading from Google Sheets:', error);
                alert(`Error loading data: ${error.message}. Using local data only.`);
                return { config: { description: '', dateRanges: [] }, participants: {} };
            }
        };

        // Calendar helper functions
        const formatDateKey = (date) => {
            // Use local date components to avoid timezone issues
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const formatDateDisplay = (date) => {
            const options = { month: 'short', day: 'numeric', weekday: 'short' };
            return date.toLocaleDateString('en-US', options);
        };

        const generateCalendarWeeks = (year, month) => {
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            const endDate = new Date(lastDay);
            
            // Adjust start to beginning of week (Monday)
            // getDay() returns 0 for Sunday, 1 for Monday, etc.
            // For Monday start: (getDay() + 6) % 7 gives days back to Monday
            startDate.setDate(startDate.getDate() - ((startDate.getDay() + 6) % 7));
            
            // Adjust end to end of week (Sunday)
            endDate.setDate(endDate.getDate() + ((7 - endDate.getDay()) % 7));
            
            const weeks = [];
            const currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                const week = [];
                for (let i = 0; i < 7; i++) {
                    week.push(new Date(currentDate));
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                weeks.push(week);
            }
            
            return weeks;
        };

        const isDateInRange = (date, ranges) => {
            const dateStr = formatDateKey(date);
            return ranges.some(range => {
                const startStr = range.startDate;
                const endStr = range.endDate;
                return dateStr >= startStr && dateStr <= endStr;
            });
        };

        const isDateInCurrentMonth = (date, displayMonth) => {
            return date.getMonth() === displayMonth.getMonth() && 
                   date.getFullYear() === displayMonth.getFullYear();
        };

        // Calendar Component
        const CalendarComponent = ({ 
            dateRanges, 
            onDateClick, 
            isAdmin, 
            participants,
            selectionStart,
            highlightedRange,
            participantName,
            initialMonth = null
        }) => {
            const getInitialDisplayMonth = () => {
                if (initialMonth) {
                    return new Date(initialMonth);
                }
                return new Date();
            };
            
            const [displayMonth, setDisplayMonth] = useState(getInitialDisplayMonth());
            
            // Update display month if initialMonth changes
            useEffect(() => {
                if (initialMonth) {
                    setDisplayMonth(new Date(initialMonth));
                }
            }, [initialMonth]);
            
            const weeks = generateCalendarWeeks(displayMonth.getFullYear(), displayMonth.getMonth());
            
            const navigateMonth = (direction) => {
                const newMonth = new Date(displayMonth);
                newMonth.setMonth(newMonth.getMonth() + direction);
                setDisplayMonth(newMonth);
            };

            const hasAvailableDatesInMonth = (year, month) => {
                if (!dateRanges || dateRanges.length === 0) return false;
                
                const monthStart = new Date(year, month, 1);
                const monthEnd = new Date(year, month + 1, 0);
                const monthStartKey = formatDateKey(monthStart);
                const monthEndKey = formatDateKey(monthEnd);
                
                return dateRanges.some(range => {
                    // Check if range overlaps with this month
                    return range.startDate <= monthEndKey && range.endDate >= monthStartKey;
                });
            };

            const prevMonth = new Date(displayMonth);
            prevMonth.setMonth(prevMonth.getMonth() - 1);
            const nextMonth = new Date(displayMonth);
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            
            const hasPrevMonthDates = hasAvailableDatesInMonth(prevMonth.getFullYear(), prevMonth.getMonth());
            const hasNextMonthDates = hasAvailableDatesInMonth(nextMonth.getFullYear(), nextMonth.getMonth());

            const getDateParticipantCount = (date) => {
                const dateKey = formatDateKey(date);
                // Only count votes for dates that are in currently active ranges
                const isDateInActiveRange = dateRanges.some(range => {
                    return dateKey >= range.startDate && dateKey <= range.endDate;
                });
                
                if (!isDateInActiveRange) {
                    return 0;
                }
                
                return Object.values(participants).filter(availability => 
                    availability.includes(dateKey)
                ).length;
            };

            const getDayClasses = (date) => {
                const isCurrentMonth = isDateInCurrentMonth(date, displayMonth);
                const isInRange = isDateInRange(date, dateRanges);
                const isSelectionStart = selectionStart && formatDateKey(date) === formatDateKey(selectionStart);
                const isInHighlightedRange = highlightedRange && 
                    formatDateKey(date) >= formatDateKey(highlightedRange.start) && 
                    formatDateKey(date) <= formatDateKey(highlightedRange.end);
                const participantCount = getDateParticipantCount(date);
                const hasParticipants = participantCount > 0;

                let classes = 'calendar-cell border border-gray-200 p-2 text-center ';
                
                if (!isCurrentMonth) {
                    classes += 'text-gray-300 ';
                }
                
                if (isAdmin) {
                    if (isInRange) {
                        if (hasParticipants) {
                            classes += 'date-selected-by-participants border-green-400 ';
                        } else {
                            classes += 'date-in-range border-blue-400 ';
                        }
                    }
                    
                    if (isSelectionStart) {
                        classes += 'bg-blue-500 text-white ';
                    }
                    
                    if (isInHighlightedRange && !isSelectionStart) {
                        classes += 'bg-blue-200 ';
                    }
                } else {
                    // Participant view
                    if (isInRange) {
                        const dateKey = formatDateKey(date);
                        const isSelectedByCurrentParticipant = participantName && 
                            participants[participantName] && 
                            participants[participantName].includes(dateKey);
                        
                        if (isSelectedByCurrentParticipant) {
                            classes += 'bg-green-100 border-green-400 ';
                        } else {
                            classes += 'bg-blue-50 border-blue-300 hover:bg-blue-100 ';
                        }
                    } else {
                        classes += 'cursor-not-allowed opacity-50 ';
                    }
                }
                
                return classes;
            };

            return (
                <div className="bg-white border border-gray-200 rounded-lg p-4">
                    <div className="flex items-center justify-between mb-4">
                        <button
                            onClick={() => navigateMonth(-1)}
                            className={`p-2 hover:bg-gray-100 rounded relative ${hasPrevMonthDates ? 'ring-2 ring-blue-300' : ''}`}
                            title={hasPrevMonthDates ? 'Previous month has available dates' : 'Previous month'}
                        >
                            <ChevronLeft className="icon" />
                            {hasPrevMonthDates && (
                                <div className="absolute -top-1 -right-1 w-3 h-3 bg-blue-500 rounded-full"></div>
                            )}
                        </button>
                        
                        <h3 className="text-lg font-semibold">
                            {displayMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                        </h3>
                        
                        <button
                            onClick={() => navigateMonth(1)}
                            className={`p-2 hover:bg-gray-100 rounded relative ${hasNextMonthDates ? 'ring-2 ring-blue-300' : ''}`}
                            title={hasNextMonthDates ? 'Next month has available dates' : 'Next month'}
                        >
                            <ChevronRight className="icon" />
                            {hasNextMonthDates && (
                                <div className="absolute -top-1 -right-1 w-3 h-3 bg-blue-500 rounded-full"></div>
                            )}
                        </button>
                    </div>
                    
                    <div className="grid grid-cols-7 gap-1">
                        {['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map(day => (
                            <div key={day} className="p-2 text-center font-medium text-gray-600 text-sm">
                                {day}
                            </div>
                        ))}
                        
                        {weeks.flat().map((date, index) => {
                            const participantCount = getDateParticipantCount(date);
                            
                            return (
                                <div
                                    key={index}
                                    className={getDayClasses(date)}
                                    onClick={() => onDateClick(date)}
                                >
                                    <div className="text-sm font-medium">
                                        {formatDateDisplay(date)}
                                    </div>
                                    {isAdmin && participantCount > 0 && (
                                        <div className="text-xs text-green-600 font-medium mt-1">
                                            {participantCount} vote{participantCount !== 1 ? 's' : ''}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const WorkshopScheduler = () => {
            const [currentView, setCurrentView] = useState(''); // Start empty, let hash determine view
            const [participantName, setParticipantName] = useState('');
            const [dateRanges, setDateRanges] = useState([]);
            const [participants, setParticipants] = useState({});
            const [workshopDescription, setWorkshopDescription] = useState('');
            const [selectionStart, setSelectionStart] = useState(null);
            const [highlightedRange, setHighlightedRange] = useState(null);
            const [saving, setSaving] = useState(false);
            const [loading, setLoading] = useState(true);
            const [showConfirmation, setShowConfirmation] = useState(false);
            const [confirmationMessage, setConfirmationMessage] = useState('');
            const [resultsData, setResultsData] = useState({ dateRanges: [], participants: {} });
            const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(false);
            const [adminPassword, setAdminPassword] = useState('');
            const [selectionMode, setSelectionMode] = useState('ranges'); // 'ranges' or 'single'
            
            // Simple admin password - change this to your preferred password
            const ADMIN_PASSWORD = 'workshop2024';

            // Load data on component mount
            useEffect(() => {
                const loadData = async () => {
                    setLoading(true);
                    try {
                        const data = await loadFromSheets();
                        setWorkshopDescription(data.config.description || '');
                        setDateRanges(data.config.dateRanges || []);
                        setParticipants(data.participants || {});
                    } catch (error) {
                        console.error('Failed to load data:', error);
                    } finally {
                        setLoading(false);
                    }
                };
                
                loadData();
            }, []);

            // Handle URL-based navigation
            useEffect(() => {
                const checkHash = () => {
                    const hash = window.location.hash.substring(1);
                    console.log('Navigation: Hash changed to:', hash);
                    
                    if (hash === 'participant') {
                        console.log('Navigation: Setting view to participant');
                        setCurrentView('participant');
                    } else if (hash === 'thank-you') {
                        console.log('Navigation: Setting view to thank-you');
                        setCurrentView('thank-you');
                    } else if (hash === 'admin') {
                        console.log('Navigation: Setting view to admin');
                        setCurrentView('admin');
                    } else {
                        // Default to participant view
                        console.log('Navigation: No hash or empty hash, defaulting to participant');
                        setCurrentView('participant');
                        window.location.hash = 'participant';
                    }
                };
                
                // Run on component mount
                checkHash();
                
                // Listen for hash changes
                window.addEventListener('hashchange', checkHash);
                return () => window.removeEventListener('hashchange', checkHash);
            }, []); // Remove isAdminAuthenticated dependency

            const switchToView = (view) => {
                console.log('Navigation: switchToView called with:', view);
                // Only update the hash - let the hash change listener update the state
                if (view === 'participant') {
                    window.location.hash = 'participant';
                } else if (view === 'thank-you') {
                    window.location.hash = 'thank-you';
                } else if (view === 'admin') {
                    window.location.hash = 'admin';
                }
            };

            const handleAdminLogin = () => {
                if (adminPassword === ADMIN_PASSWORD) {
                    setIsAdminAuthenticated(true);
                    setAdminPassword('');
                    // Stay on admin view but now authenticated
                } else {
                    alert('Incorrect password. Access denied.');
                    setAdminPassword('');
                }
            };

            const handleSelectionModeChange = (mode) => {
                setSelectionMode(mode);
                // Clear any pending selection when switching modes
                setSelectionStart(null);
                setHighlightedRange(null);
            };

            const handleAdminLogout = () => {
                setIsAdminAuthenticated(false);
                switchToView('participant');
            };

            const copyParticipantLink = () => {
                const participantUrl = `${window.location.origin}${window.location.pathname}#participant`;
                navigator.clipboard.writeText(participantUrl);
                alert('Participant link copied to clipboard!');
            };

            const saveWorkshopConfig = async (updatedRanges = dateRanges) => {
                const config = {
                    type: 'config',
                    description: workshopDescription,
                    dateRanges: updatedRanges,
                    // Also send as timeSlots for Google Sheets compatibility
                    timeSlots: updatedRanges.map(range => ({
                        id: range.id,
                        dateFrom: range.startDate,
                        dateTo: range.endDate,
                        description: range.description
                    }))
                };
                
                await saveToSheets(config);
            };

            const handleAdminDateClick = async (date) => {
                const dateKey = formatDateKey(date);
                
                // Check if this date is already in an existing range
                const existingRange = dateRanges.find(range => {
                    return dateKey >= range.startDate && dateKey <= range.endDate;
                });
                
                if (existingRange) {
                    // Date is already in a range - ask if user wants to remove the range
                    const confirmRemove = window.confirm(
                        `This date is already part of the range:\n"${formatRangeDisplay(existingRange)}"\n\nDo you want to remove this entire range?`
                    );
                    
                    if (confirmRemove) {
                        await removeRange(existingRange.id);
                        setConfirmationMessage('Date range removed successfully!');
                        setShowConfirmation(true);
                        setTimeout(() => setShowConfirmation(false), 3000);
                    }
                    return;
                }
                
                if (selectionMode === 'single') {
                    // Single date mode - immediately create a single-day range
                    const newRange = {
                        id: Date.now(),
                        startDate: dateKey,
                        endDate: dateKey,
                        description: workshopDescription
                    };
                    
                    const updatedRanges = [...dateRanges, newRange];
                    setDateRanges(updatedRanges);
                    
                    // Save to Google Sheets and show confirmation
                    try {
                        await saveWorkshopConfig(updatedRanges);
                        setConfirmationMessage('Single date added successfully!');
                        setShowConfirmation(true);
                        setTimeout(() => setShowConfirmation(false), 3000);
                    } catch (error) {
                        console.error('Error saving workshop config:', error);
                    }
                } else {
                    // Range mode - two-click selection process
                    if (!selectionStart) {
                        // First click - set start date
                        setSelectionStart(date);
                        setHighlightedRange({ start: date, end: date });
                    } else {
                        // Second click - complete range selection
                        const startDate = new Date(Math.min(selectionStart, date));
                        const endDate = new Date(Math.max(selectionStart, date));
                        
                        const newRange = {
                            id: Date.now(),
                            startDate: formatDateKey(startDate),
                            endDate: formatDateKey(endDate),
                            description: workshopDescription
                        };
                        
                        const updatedRanges = [...dateRanges, newRange];
                        setDateRanges(updatedRanges);
                        setSelectionStart(null);
                        setHighlightedRange(null);
                        
                        // Save to Google Sheets and show confirmation
                        try {
                            await saveWorkshopConfig(updatedRanges);
                            setConfirmationMessage('Date range saved successfully!');
                            setShowConfirmation(true);
                            setTimeout(() => setShowConfirmation(false), 3000);
                        } catch (error) {
                            console.error('Error saving workshop config:', error);
                        }
                    }
                }
            };

            const handleParticipantDateClick = (date) => {
                if (!participantName) return;
                
                const dateKey = formatDateKey(date);
                const isInAdminRange = isDateInRange(date, dateRanges);
                
                if (!isInAdminRange) return;
                
                const currentAvailability = participants[participantName] || [];
                let updatedAvailability;
                
                if (currentAvailability.includes(dateKey)) {
                    // Date is already selected - deselect it
                    updatedAvailability = currentAvailability.filter(d => d !== dateKey);
                    console.log('Participant: Deselecting date', dateKey);
                } else {
                    // Date is not selected - select it
                    updatedAvailability = [...currentAvailability, dateKey];
                    console.log('Participant: Selecting date', dateKey);
                }
                
                setParticipants({
                    ...participants,
                    [participantName]: updatedAvailability
                });
            };

            const removeRange = async (rangeId) => {
                const updatedRanges = dateRanges.filter(range => range.id !== rangeId);
                setDateRanges(updatedRanges);
                
                // Keep participant votes intact - only remove the range
                // Votes will be filtered by active ranges in the results calculations
                
                await saveWorkshopConfig(updatedRanges);
            };

            const confirmAvailability = async () => {
                if (participantName && participants[participantName]?.length > 0) {
                    setSaving(true);
                    
                    try {
                        // Convert selected dates back to the format expected by Google Apps Script
                        const selectedDates = participants[participantName];
                        
                        const participantData = {
                            type: 'participant',
                            name: participantName,
                            selectedSlots: selectedDates, // Keep the original field name
                            selectedDates: selectedDates  // Also send as selectedDates for backward compatibility
                        };
                        
                        console.log('=== SAVING PARTICIPANT RESPONSE ===');
                        console.log('Participant name:', participantName);
                        console.log('Selected dates:', selectedDates);
                        console.log('Data being sent:', participantData);
                        
                        await saveToSheets(participantData);
                        
                        // Load fresh results data for thank you page
                        try {
                            const data = await loadFromSheets();
                            setResultsData({
                                dateRanges: data.config.dateRanges || [],
                                participants: data.participants || {}
                            });
                        } catch (error) {
                            console.error('Error loading results for thank you page:', error);
                        }
                        
                        switchToView('thank-you');
                    } catch (error) {
                        console.error('Save error:', error);
                        alert(`Error saving your response: ${error.message}`);
                    } finally {
                        setSaving(false);
                    }
                } else {
                    alert('Please enter your name and select at least one date before confirming.');
                }
            };

            // Helper functions for results
            const getDateParticipantCount = (dateKey, participantsData = participants, activeRanges = dateRanges) => {
                // Only count votes for dates that are in currently active ranges
                const isDateInActiveRange = activeRanges.some(range => {
                    return dateKey >= range.startDate && dateKey <= range.endDate;
                });
                
                if (!isDateInActiveRange) {
                    return 0;
                }
                
                return Object.values(participantsData).filter(availability => 
                    availability.includes(dateKey)
                ).length;
            };

            const getDateParticipants = (dateKey, participantsData = participants, activeRanges = dateRanges) => {
                // Only include participants for dates that are in currently active ranges
                const isDateInActiveRange = activeRanges.some(range => {
                    return dateKey >= range.startDate && dateKey <= range.endDate;
                });
                
                if (!isDateInActiveRange) {
                    return [];
                }
                
                return Object.keys(participantsData).filter(name => 
                    participantsData[name].includes(dateKey)
                );
            };

            const getRangeParticipants = (range, participantsData = participants, activeRanges = dateRanges) => {
                // Get all dates in the range
                const rangeDates = [];
                const start = new Date(range.startDate);
                const end = new Date(range.endDate);
                
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    rangeDates.push(formatDateKey(d));
                }
                
                // Only consider this range if it's in the active ranges
                const isRangeActive = activeRanges.some(activeRange => activeRange.id === range.id);
                if (!isRangeActive) {
                    return {
                        count: 0,
                        names: [],
                        rangeDates: rangeDates
                    };
                }
                
                // Find participants who selected ALL dates in this range
                const participantsWithFullRange = Object.keys(participantsData).filter(name => {
                    const userDates = participantsData[name] || [];
                    return rangeDates.every(dateKey => userDates.includes(dateKey));
                });
                
                return {
                    count: participantsWithFullRange.length,
                    names: participantsWithFullRange,
                    rangeDates: rangeDates
                };
            };

            const getAllSelectedDates = (rangesData = dateRanges, participantsData = participants) => {
                const allDates = new Set();
                rangesData.forEach(range => {
                    const start = new Date(range.startDate);
                    const end = new Date(range.endDate);
                    
                    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                        allDates.add(formatDateKey(d));
                    }
                });
                
                return Array.from(allDates).sort().map(dateKey => ({
                    dateKey,
                    count: getDateParticipantCount(dateKey, participantsData, rangesData),
                    names: getDateParticipants(dateKey, participantsData, rangesData),
                    displayDate: new Date(dateKey).toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })
                }));
            };

            const formatRangeDisplay = (range) => {
                const startDate = new Date(range.startDate);
                const endDate = new Date(range.endDate);
                
                if (range.startDate === range.endDate) {
                    return startDate.toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                } else {
                    return `${startDate.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric' 
                    })} - ${endDate.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric',
                        year: 'numeric' 
                    })}`;
                }
            };

            if (loading) {
                return (
                    <div className="max-w-6xl mx-auto p-6 bg-white min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto mb-4"></div>
                            <p className="text-gray-600">Loading workshop data from Google Sheets...</p>
                        </div>
                    </div>
                );
            }

            // Don't render anything until currentView is determined
            if (!currentView) {
                return null;
            }

            if (currentView === 'thank-you') {
                const totalResultsParticipants = Object.keys(resultsData.participants).length;
                
                // Calculate results for each date range
                const rangeResults = (resultsData.dateRanges || []).map(range => {
                    const rangeData = getRangeParticipants(range, resultsData.participants, resultsData.dateRanges);
                    return {
                        ...range,
                        count: rangeData.count,
                        participants: rangeData.names,
                        rangeDates: rangeData.rangeDates
                    };
                }).sort((a, b) => b.count - a.count);

                const maxResultsAvailability = Math.max(...rangeResults.map(range => range.count), 0);

                return (
                    <div className="max-w-6xl mx-auto p-6 bg-white min-h-screen">
                        <div className="text-center mb-8">
                            <CheckCircle className="icon-3xl text-green-600 mx-auto mb-4" />
                            <h1 className="text-4xl font-bold text-gray-900 mb-2">Thank You!</h1>
                            <p className="text-xl text-gray-600 mb-6">Your availability has been saved successfully.</p>
                            
                            <div className="bg-green-50 border border-green-200 rounded-lg p-6 mb-6 max-w-md mx-auto">
                                <h3 className="font-semibold text-green-800 mb-2">What's Next?</h3>
                                <p className="text-green-700 text-sm">
                                    The workshop organizer will review all responses and announce the final dates soon. 
                                    Check out the current results below!
                                </p>
                            </div>
                        </div>

                        {totalResultsParticipants > 0 && rangeResults.length > 0 ? (
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                {/* Results Analysis - Left/Center */}
                                <div className="lg:col-span-2 space-y-6">
                                    {/* Overview Results */}
                                    <div className="bg-white border border-gray-200 rounded-lg p-6">
                                        <div className="flex items-center gap-2 mb-4">
                                            <Users className="icon-lg text-purple-600" />
                                            <h3 className="text-xl font-semibold">Results Overview</h3>
                                            <span className="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-sm font-medium">
                                                {totalResultsParticipants} participant{totalResultsParticipants !== 1 ? 's' : ''} so far
                                            </span>
                                        </div>
                                        
                                        <div className="space-y-3">
                                            {rangeResults.slice(0, 4).map((range, index) => {
                                                const percentage = totalResultsParticipants > 0 ? (range.count / totalResultsParticipants) * 100 : 0;
                                                const isWinner = range.count === maxResultsAvailability && range.count > 0;
                                                const rank = index + 1;
                                                
                                                return (
                                                    <div key={range.id} className={`p-3 rounded-lg border ${isWinner ? 'border-green-500 bg-green-50' : 'border-gray-200 bg-white'}`}>
                                                        <div className="flex items-center justify-between">
                                                            <div className="flex items-center gap-3">
                                                                <div className={`w-6 h-6 rounded-full flex items-center justify-center font-bold text-white text-sm ${
                                                                    rank === 1 ? 'bg-green-600' : 
                                                                    rank === 2 ? 'bg-green-400' : 
                                                                    rank === 3 ? 'bg-blue-400' : 'bg-gray-300'
                                                                }`}>
                                                                    {rank}
                                                                </div>
                                                                {isWinner && <CheckCircle className="icon text-green-600" />}
                                                                <div>
                                                                    <div className={`font-medium ${isWinner ? 'text-green-700' : 'text-gray-900'}`}>
                                                                        {formatRangeDisplay(range)}
                                                                    </div>
                                                                    <div className="text-sm text-gray-500">
                                                                        {range.rangeDates?.length || 1} day{(range.rangeDates?.length || 1) !== 1 ? 's' : ''}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div className="text-right">
                                                                <div className={`text-xl font-bold ${isWinner ? 'text-green-600' : 'text-gray-900'}`}>
                                                                    {range.count}/{totalResultsParticipants}
                                                                </div>
                                                                <div className="text-sm text-gray-500">{Math.round(percentage)}%</div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div className="w-full bg-gray-200 rounded-full h-2 mt-2">
                                                            <div 
                                                                className={`h-2 rounded-full ${
                                                                    rank === 1 ? 'bg-green-600' : 
                                                                    rank === 2 ? 'bg-green-400' : 
                                                                    rank === 3 ? 'bg-blue-400' : 'bg-gray-300'
                                                                } ${isWinner ? 'bg-green-600' : ''}`}
                                                                style={{ width: `${percentage}%` }}
                                                            ></div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>

                                        {rangeResults.length > 4 && (
                                            <div className="mt-3 text-center">
                                                <p className="text-sm text-gray-500">
                                                    Showing top 4 of {rangeResults.length} options
                                                </p>
                                            </div>
                                        )}

                                        {maxResultsAvailability > 0 && (
                                            <div className="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                                                <h4 className="font-semibold text-green-800 mb-1">
                                                    ðŸ† Current Winner{rangeResults.filter(range => range.count === maxResultsAvailability).length > 1 ? 's' : ''}:
                                                </h4>
                                                <div className="space-y-1">
                                                    {rangeResults
                                                        .filter(range => range.count === maxResultsAvailability)
                                                        .slice(0, 3)
                                                        .map(range => (
                                                            <div key={range.id} className="text-green-700 font-medium text-sm">
                                                                {formatRangeDisplay(range)} ({range.count} participant{range.count !== 1 ? 's' : ''})
                                                            </div>
                                                        ))}
                                                    {rangeResults.filter(range => range.count === maxResultsAvailability).length > 3 && (
                                                        <div className="text-green-600 text-xs">
                                                            +{rangeResults.filter(range => range.count === maxResultsAvailability).length - 3} more tied
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* Luis the Cat - Right Side */}
                                <div className="lg:col-span-1">
                                    <div className="bg-white border border-gray-200 rounded-lg p-6 text-center">
                                        <div className="mb-4">
                                            <img 
                                                src="./Luis.jpg" 
                                                alt="Luis the cat" 
                                                className="w-full h-96 object-cover rounded-lg shadow-md"
                                                onError={(e) => {
                                                    e.target.style.display = 'none';
                                                    e.target.nextSibling.style.display = 'block';
                                                }}
                                            />
                                            <div className="hidden bg-gray-100 h-96 rounded-lg flex items-center justify-center">
                                                <div className="text-center text-gray-500">
                                                    <div className="text-4xl mb-2">ðŸ±</div>
                                                    <p className="text-sm">Interesting choice.</p>
                                                </div>
                                            </div>
                                        </div>
                                        <p className="text-sm text-gray-600">
                                            Interesting choice.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div className="text-center py-8 bg-gray-50 rounded-lg">
                                    <p className="text-gray-600">No results to display yet. More votes needed!</p>
                                </div>
                                <div className="bg-white border border-gray-200 rounded-lg p-6 text-center">
                                    <img 
                                        src="./Luis.jpg" 
                                        alt="Luis the cat" 
                                        className="w-full h-80 object-cover rounded-lg shadow-md"
                                        onError={(e) => {
                                            e.target.style.display = 'none';
                                            e.target.nextSibling.style.display = 'block';
                                        }}
                                    />
                                    <div className="hidden bg-gray-100 h-80 rounded-lg flex items-center justify-center">
                                        <div className="text-center text-gray-500">
                                            <div className="text-4xl mb-2">ðŸ±</div>
                                            <p className="text-sm">Interesting choice.</p>
                                        </div>
                                    </div>
                                    <p className="text-sm text-gray-600 mt-4">
                                        Interesting choice.
                                    </p>
                                </div>
                            </div>
                        )}

                        <div className="text-center space-y-3 mt-8">
                            <button
                                onClick={() => switchToView('participant')}
                                className="block w-full max-w-sm mx-auto px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                            >
                                View/Edit My Response
                            </button>
                            
                            <button
                                onClick={() => switchToView('admin')}
                                className="block w-full max-w-sm mx-auto px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
                            >
                                View Full Results (Admin)
                            </button>
                        </div>
                    </div>
                );
            }

            if (currentView === 'admin') {
                if (!isAdminAuthenticated) {
                    return (
                        <div className="max-w-md mx-auto p-6 bg-white min-h-screen flex items-center justify-center">
                            <div className="w-full">
                                <div className="text-center mb-8">
                                    <Settings className="icon-3xl text-blue-600 mx-auto mb-4" />
                                    <h1 className="text-3xl font-bold text-gray-900 mb-2">Admin Access</h1>
                                    <p className="text-gray-600">Enter the admin password to access the full results and calendar management.</p>
                                </div>

                                <div className="bg-white border border-gray-200 rounded-lg p-6">
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Admin Password</label>
                                        <input
                                            type="password"
                                            placeholder="Enter admin password"
                                            value={adminPassword}
                                            onChange={(e) => setAdminPassword(e.target.value)}
                                            onKeyPress={(e) => e.key === 'Enter' && handleAdminLogin()}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        />
                                    </div>
                                    
                                    <button
                                        onClick={handleAdminLogin}
                                        className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                                    >
                                        Access Admin Panel
                                    </button>
                                </div>

                                <div className="text-center mt-6">
                                    <button
                                        onClick={() => switchToView('participant')}
                                        className="text-blue-600 hover:text-blue-700 text-sm"
                                    >
                                        â† Back to Participant View
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                }

                const totalParticipants = Object.keys(participants).length;
                
                // Calculate results for each date range
                const rangeResults = dateRanges.map(range => {
                    const rangeData = getRangeParticipants(range, participants, dateRanges);
                    return {
                        ...range,
                        count: rangeData.count,
                        participants: rangeData.names,
                        rangeDates: rangeData.rangeDates
                    };
                }).sort((a, b) => b.count - a.count);

                const maxRangeAvailability = Math.max(...rangeResults.map(range => range.count), 0);

                return (
                    <div className="max-w-6xl mx-auto p-6 bg-white">
                        {/* Confirmation Message */}
                        {showConfirmation && (
                            <div className="fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2">
                                <CheckCircle className="icon" />
                                <span>{confirmationMessage || 'Action completed successfully!'}</span>
                            </div>
                        )}

                        <div className="flex items-center justify-between mb-6">
                            <div className="flex items-center gap-3">
                                <Calendar className="icon-xl text-blue-600" />
                                <h1 className="text-3xl font-bold text-gray-900">Workshop Scheduler</h1>
                            </div>
                            <div className="flex gap-2">
                                <button
                                    onClick={() => window.open('https://docs.google.com/spreadsheets/d/1qRAhPCd39aHXP6Ju25_JQNHWP9QBPyn8zB80x2GDk40/edit?gid=343624849#gid=343624849', '_blank')}
                                    className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                                >
                                    ðŸ“Š Open Google Sheet
                                </button>
                                <button
                                    onClick={copyParticipantLink}
                                    className="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
                                >
                                    <Link className="icon" />
                                    Copy Participant Link
                                </button>
                                <button
                                    onClick={() => switchToView('participant')}
                                    className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                >
                                    <User className="icon" />
                                    Participant View
                                </button>
                                <button
                                    onClick={handleAdminLogout}
                                    className="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                                >
                                    <Settings className="icon" />
                                    Logout
                                </button>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            {/* Left Column - Calendar and Configuration */}
                            <div className="space-y-6">
                                <div className="bg-white border border-gray-200 rounded-lg p-6">
                                    <h3 className="text-lg font-semibold mb-4">Workshop Configuration</h3>
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Workshop Description</label>
                                        <input
                                            type="text"
                                            placeholder="e.g., Sprint Planning Workshop"
                                            value={workshopDescription}
                                            onChange={(e) => setWorkshopDescription(e.target.value)}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        />
                                    </div>
                                    
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-3">Date Selection Mode</label>
                                        <div className="space-y-2">
                                            <label className="flex items-center">
                                                <input
                                                    type="radio"
                                                    name="selectionMode"
                                                    value="ranges"
                                                    checked={selectionMode === 'ranges'}
                                                    onChange={(e) => handleSelectionModeChange(e.target.value)}
                                                    className="mr-2"
                                                />
                                                <span className="text-sm">Select ranges (first click = start, second click = end)</span>
                                            </label>
                                            <label className="flex items-center">
                                                <input
                                                    type="radio"
                                                    name="selectionMode"
                                                    value="single"
                                                    checked={selectionMode === 'single'}
                                                    onChange={(e) => handleSelectionModeChange(e.target.value)}
                                                    className="mr-2"
                                                />
                                                <span className="text-sm">Select single dates (each click adds one day)</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div className="text-sm text-gray-600 mb-4">
                                        {selectionMode === 'ranges' ? (
                                            selectionStart ? (
                                                <p className="text-blue-600 font-medium">
                                                    ðŸ“… Click a second date to complete your range selection
                                                </p>
                                            ) : (
                                                <div>
                                                    <p className="mb-2">
                                                        <strong>Range Mode:</strong> Click two dates on the calendar to create a date range. First click = start date, second click = end date.
                                                    </p>
                                                    <p className="text-sm text-gray-500">
                                                        ðŸ’¡ <strong>Tip:</strong> Click on any date that's already in a range to remove that entire range.
                                                    </p>
                                                </div>
                                            )
                                        ) : (
                                            <div>
                                                <p className="mb-2">
                                                    <strong>Single Date Mode:</strong> Each click on a date immediately adds that single day as an option.
                                                </p>
                                                <p className="text-sm text-gray-500">
                                                    ðŸ’¡ <strong>Tip:</strong> Click on any selected date to remove it.
                                                </p>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <CalendarComponent
                                    dateRanges={dateRanges}
                                    onDateClick={handleAdminDateClick}
                                    isAdmin={true}
                                    participants={participants}
                                    selectionStart={selectionStart}
                                    highlightedRange={highlightedRange}
                                />
                            </div>

                            {/* Right Column - Selected Ranges and Results */}
                            <div className="space-y-6">
                                {dateRanges.length > 0 && (
                                    <div className="bg-white border border-gray-200 rounded-lg p-6">
                                        <h3 className="text-lg font-semibold mb-4">Selected Date Ranges</h3>
                                        <div className="space-y-3">
                                            {dateRanges.map((range) => (
                                                <div key={range.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                    <div>
                                                        <div className="font-medium">{formatRangeDisplay(range)}</div>
                                                    </div>
                                                    <button
                                                        onClick={() => removeRange(range.id)}
                                                        className="text-red-600 hover:text-red-800 p-1"
                                                    >
                                                        <Trash2 className="icon" />
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {totalParticipants > 0 && rangeResults.length > 0 && (
                                    <div className="bg-white border border-gray-200 rounded-lg p-6">
                                        <div className="flex items-center gap-2 mb-4">
                                            <Users className="icon-lg text-green-600" />
                                            <h3 className="text-lg font-semibold">Results by Range ({totalParticipants} participants)</h3>
                                        </div>
                                        
                                        <div className="text-sm text-gray-600 mb-4">
                                            Showing participants available for the ENTIRE date range.
                                        </div>
                                        
                                        <div className="space-y-4 max-h-96 overflow-y-auto">
                                            {rangeResults.map((range, index) => {
                                                const percentage = totalParticipants > 0 ? (range.count / totalParticipants) * 100 : 0;
                                                const isWinner = range.count === maxRangeAvailability && range.count > 0;
                                                
                                                return (
                                                    <div key={range.id} className={`p-4 rounded-lg border ${isWinner ? 'border-green-500 bg-green-50' : 'border-gray-200'}`}>
                                                        <div className="flex items-start justify-between mb-2">
                                                            <div className="flex items-center gap-2">
                                                                {isWinner && <CheckCircle className="icon-lg text-green-600" />}
                                                                <div>
                                                                    <div className="font-semibold text-lg">{formatRangeDisplay(range)}</div>
                                                                    <div className="text-sm text-gray-500">
                                                                        {range.rangeDates.length} day{range.rangeDates.length !== 1 ? 's' : ''}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div className="text-right">
                                                                <div className={`text-2xl font-bold ${isWinner ? 'text-green-600' : 'text-gray-900'}`}>
                                                                    {range.count}/{totalParticipants}
                                                                </div>
                                                                <div className="text-sm text-gray-500">{Math.round(percentage)}% available</div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div className="w-full bg-gray-200 rounded-full h-2 mb-3">
                                                            <div 
                                                                className={`h-2 rounded-full ${isWinner ? 'bg-green-500' : 'bg-blue-500'}`}
                                                                style={{ width: `${percentage}%` }}
                                                            ></div>
                                                        </div>
                                                        
                                                        {range.participants.length > 0 && (
                                                            <div>
                                                                <div className="text-sm font-medium text-gray-700 mb-2">
                                                                    Available for entire range:
                                                                </div>
                                                                <div className="flex flex-wrap gap-2">
                                                                    {range.participants.map((name) => (
                                                                        <span key={name} className="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm">
                                                                            {name}
                                                                        </span>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}
                                                        
                                                        {range.count === 0 && (
                                                            <div className="text-sm text-gray-500 italic">
                                                                No participants available for the entire range
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>

                                        {maxRangeAvailability > 0 && (
                                            <div className="mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                                                <h4 className="font-semibold text-green-800 mb-2">ðŸ† Winner Range{rangeResults.filter(range => range.count === maxRangeAvailability).length > 1 ? 's' : ''}:</h4>
                                                <div className="space-y-1">
                                                    {rangeResults
                                                        .filter(range => range.count === maxRangeAvailability)
                                                        .map(range => (
                                                            <div key={range.id} className="text-green-700 font-medium">
                                                                {formatRangeDisplay(range)} ({range.count} participant{range.count !== 1 ? 's' : ''})
                                                            </div>
                                                        ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // Participant View
            const getOptimalStartingMonth = () => {
                if (!dateRanges || dateRanges.length === 0) {
                    return null; // Use current month
                }
                
                // Find the earliest start date among all ranges
                const earliestDate = dateRanges.reduce((earliest, range) => {
                    const rangeStart = new Date(range.startDate);
                    return !earliest || rangeStart < earliest ? rangeStart : earliest;
                }, null);
                
                if (!earliestDate) {
                    return null; // Use current month
                }
                
                const currentMonth = new Date();
                currentMonth.setDate(1); // Set to first day for proper comparison
                
                const earliestMonth = new Date(earliestDate);
                earliestMonth.setDate(1); // Set to first day for proper comparison
                
                // If earliest date is in a future month, use that month
                if (earliestMonth > currentMonth) {
                    return earliestMonth;
                }
                
                return null; // Use current month
            };
            
            return (
                <div className="max-w-6xl mx-auto p-6 bg-white">
                    <div className="flex items-center justify-between mb-6">
                        <div className="flex items-center gap-3">
                            <Users className="icon-xl text-green-600" />
                            <h1 className="text-3xl font-bold text-gray-900">Select Your Availability</h1>
                        </div>
                        <button
                            onClick={() => switchToView('admin')}
                            className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                        >
                            <Settings className="icon" />
                            Admin View
                        </button>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* Left Column - Participant Info and Calendar */}
                        <div className="space-y-6">
                            <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                <div className="mb-3">
                                    <label className="block text-sm font-medium text-green-900 mb-2">Your Name</label>
                                    <input
                                        type="text"
                                        placeholder="Enter your name"
                                        value={participantName}
                                        onChange={(e) => setParticipantName(e.target.value)}
                                        className="w-full max-w-sm px-3 py-2 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                    />
                                </div>
                                <div className="text-green-700 text-sm space-y-1">
                                    <p>Click on available dates in the calendar to select your availability. Selected dates will turn green.</p>
                                    <p className="text-xs text-green-600">
                                        ðŸ’¡ <strong>Tip:</strong> Click on a green date again to deselect it.
                                    </p>
                                </div>
                            </div>

                            <CalendarComponent
                                dateRanges={dateRanges}
                                onDateClick={handleParticipantDateClick}
                                isAdmin={false}
                                participants={participants}
                                participantName={participantName}
                                initialMonth={getOptimalStartingMonth()}
                            />
                        </div>

                        {/* Right Column - Selection Summary */}
                        <div className="space-y-6">
                            {participantName && participants[participantName]?.length > 0 && (
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <h4 className="font-semibold text-blue-800 mb-3">Your Selected Dates:</h4>
                                    <div className="space-y-2 max-h-48 overflow-y-auto">
                                        {participants[participantName]
                                            .sort()
                                            .map(dateKey => {
                                                const date = new Date(dateKey);
                                                const displayDate = date.toLocaleDateString('en-US', { 
                                                    weekday: 'long', 
                                                    year: 'numeric', 
                                                    month: 'long', 
                                                    day: 'numeric' 
                                                });
                                                return (
                                                    <div key={dateKey} className="text-blue-700 text-sm">
                                                        âœ“ {displayDate}
                                                    </div>
                                                );
                                            })}
                                    </div>
                                    
                                    <div className="mt-4">
                                        <button
                                            onClick={confirmAvailability}
                                            disabled={saving}
                                            className="w-full px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                        >
                                            {saving ? (
                                                <>
                                                    <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                                                    Saving...
                                                </>
                                            ) : (
                                                <>
                                                    <Save className="icon" />
                                                    Confirm My Availability
                                                </>
                                            )}
                                        </button>
                                    </div>
                                </div>
                            )}

                            {dateRanges.length === 0 && (
                                <div className="text-center py-12 bg-gray-50 rounded-lg">
                                    <Calendar className="icon-3xl text-gray-400 mx-auto mb-4" />
                                    <h3 className="text-lg font-medium text-gray-900 mb-2">No Dates Available</h3>
                                    <p className="text-gray-600">The administrator hasn't selected any date ranges yet.</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<WorkshopScheduler />, document.getElementById('root'));
    </script>
</body>
</html>
