<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workshop Scheduler</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .icon { width: 1rem; height: 1rem; display: inline-block; }
        .icon-lg { width: 1.5rem; height: 1.5rem; }
        .icon-xl { width: 2rem; height: 2rem; }
        .icon-2xl { width: 4rem; height: 4rem; }
        .icon-3xl { width: 5rem; height: 5rem; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Google Apps Script Configuration - UPDATED WITH NEW DEPLOYMENT URL
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxVUTZA03Ct-MPVtf2BN-j7KC86xc295YXVSAgtDETXropngEQBCBbXDeDTB4uXDUFa9w/exec';

        // Icon components
        const Calendar = ({ className = "icon" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        );

        const Clock = ({ className = "icon" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12,6 12,12 16,14"></polyline>
            </svg>
        );

        const Users = ({ className = "icon" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
        );

        const Plus = ({ className = "icon" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const Trash2 = ({ className = "icon" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="3,6 5,6 21,6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );

        const CheckCircle = ({ className = "icon" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22,4 12,14.01 9,11.01"></polyline>
            </svg>
        );

        const User = ({ className = "icon" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
        );

        const Settings = ({ className = "icon" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
        );

        const Link = ({ className = "icon" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
            </svg>
        );

        const Save = ({ className = "icon" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17,21 17,13 7,13 7,21"></polyline>
                <polyline points="7,3 7,8 15,8"></polyline>
            </svg>
        );

        // Google Sheets API functions - CORS-friendly version
        const saveToSheets = async (data) => {
            try {
                console.log('Attempting to save to Google Sheets:', data);
                console.log('Using URL:', GOOGLE_SCRIPT_URL);
                
                // Use form data instead of JSON to avoid CORS preflight
                const formData = new FormData();
                formData.append('data', JSON.stringify(data));
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error text:', errorText);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                console.log('Success result:', result);
                return result;
            } catch (error) {
                console.error('Error saving to Google Sheets:', error);
                alert(`Error saving data: ${error.message}. Check the browser console for details.`);
                throw error;
            }
        };

        const loadFromSheets = async () => {
            try {
                console.log('Loading data from Google Sheets...');
                console.log('Using URL:', GOOGLE_SCRIPT_URL);
                
                const response = await fetch(GOOGLE_SCRIPT_URL);
                console.log('Load response status:', response.status);
                console.log('Load response ok:', response.ok);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Load response error text:', errorText);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('Load success result:', result);
                return result;
            } catch (error) {
                console.error('Error loading from Google Sheets:', error);
                alert(`Error loading data: ${error.message}. Using local data only.`);
                return { config: { description: '', timeSlots: [] }, participants: {} };
            }
        };

        // Debug tools - available globally for troubleshooting
        window.debugWorkshopScheduler = {
            testConnection: async () => {
                console.log('=== TESTING CONNECTION TO APPS SCRIPT ===');
                console.log('URL:', GOOGLE_SCRIPT_URL);
                
                try {
                    // Test GET request
                    console.log('1. Testing GET request...');
                    const getResponse = await fetch(GOOGLE_SCRIPT_URL);
                    console.log('GET Response status:', getResponse.status);
                    console.log('GET Response ok:', getResponse.ok);
                    
                    if (getResponse.ok) {
                        const getData = await getResponse.json();
                        console.log('✅ GET Success:', getData);
                    } else {
                        const getError = await getResponse.text();
                        console.log('❌ GET Error:', getError);
                    }
                    
                    // Test POST request with form data (CORS-friendly)
                    console.log('2. Testing POST request (CORS-friendly)...');
                    const testData = {
                        type: 'config',
                        description: 'Test Workshop Debug',
                        timeSlots: [{
                            id: 999999,
                            dateFrom: '2024-01-15',
                            dateTo: '2024-01-15',
                            description: 'Test Workshop Debug'
                        }]
                    };
                    
                    const formData = new FormData();
                    formData.append('data', JSON.stringify(testData));
                    
                    const postResponse = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        body: formData
                    });
                    
                    console.log('POST Response status:', postResponse.status);
                    console.log('POST Response ok:', postResponse.ok);
                    
                    if (postResponse.ok) {
                        const postData = await postResponse.json();
                        console.log('✅ POST Success:', postData);
                        console.log('✅ Connection test PASSED! Your Apps Script is working.');
                    } else {
                        const postError = await postResponse.text();
                        console.log('❌ POST Error:', postError);
                    }
                    
                } catch (error) {
                    console.error('❌ Connection test FAILED:', error);
                    console.log('This usually means:');
                    console.log('1. Apps Script URL is wrong');
                    console.log('2. Apps Script deployment has wrong permissions');
                    console.log('3. Network/CORS issue');
                }
                
                console.log('=== CONNECTION TEST COMPLETE ===');
            },
            
            checkConfig: () => {
                console.log('=== CURRENT CONFIGURATION ===');
                console.log('Apps Script URL:', GOOGLE_SCRIPT_URL);
                console.log('Google Sheet URL: https://docs.google.com/spreadsheets/d/1qRAhPCd39aHXP6Ju25_JQNHWP9QBPyn8zB80x2GDk40/edit');
                return {
                    scriptUrl: GOOGLE_SCRIPT_URL,
                    sheetUrl: 'https://docs.google.com/spreadsheets/d/1qRAhPCd39aHXP6Ju25_JQNHWP9QBPyn8zB80x2GDk40/edit'
                };
            },

            testDirectAccess: () => {
                console.log('Opening Apps Script URL in new tab...');
                window.open(GOOGLE_SCRIPT_URL, '_blank');
                console.log('You should see JSON data like: {"config":{"description":"","timeSlots":[]},"participants":{}}');
                console.log('If you see an error page instead, there\'s a problem with your Apps Script deployment.');
            }
        };

        console.log('🔧 Debug tools loaded! Available commands:');
        console.log('• debugWorkshopScheduler.testConnection() - Test connection to Google Sheets');
        console.log('• debugWorkshopScheduler.checkConfig() - Show current configuration');
        console.log('• debugWorkshopScheduler.testDirectAccess() - Open Apps Script URL directly');

        const WorkshopScheduler = () => {
            const [currentView, setCurrentView] = useState('admin');
            const [participantName, setParticipantName] = useState('');
            const [timeSlots, setTimeSlots] = useState([]);
            const [participants, setParticipants] = useState({});
            const [workshopDescription, setWorkshopDescription] = useState('');
            const [newSlot, setNewSlot] = useState({
                startDate: '',
                endDate: ''
            });
            const [showDatePicker, setShowDatePicker] = useState(false);
            const [saving, setSaving] = useState(false);
            const [loading, setLoading] = useState(true);

            // Load data on component mount
            useEffect(() => {
                const loadData = async () => {
                    setLoading(true);
                    try {
                        console.log('=== WORKSHOP SCHEDULER STARTUP ===');
                        console.log('Apps Script URL:', GOOGLE_SCRIPT_URL);
                        console.log('Google Sheet URL: https://docs.google.com/spreadsheets/d/1qRAhPCd39aHXP6Ju25_JQNHWP9QBPyn8zB80x2GDk40/edit');
                        
                        const data = await loadFromSheets();
                        setWorkshopDescription(data.config.description || '');
                        setTimeSlots(data.config.timeSlots || []);
                        setParticipants(data.participants || {});
                        
                        console.log('Loaded workshop description:', data.config.description);
                        console.log('Loaded time slots:', data.config.timeSlots?.length || 0);
                        console.log('Loaded participants:', Object.keys(data.participants || {}).length);
                        console.log('=== STARTUP COMPLETE ===');
                    } catch (error) {
                        console.error('Failed to load data:', error);
                    } finally {
                        setLoading(false);
                    }
                };
                
                loadData();
            }, []);

            // Handle URL-based navigation
            useEffect(() => {
                const checkHash = () => {
                    const hash = window.location.hash.substring(1);
                    if (hash === 'participant') {
                        setCurrentView('participant');
                    } else if (hash === 'thank-you') {
                        setCurrentView('thank-you');
                    } else {
                        setCurrentView('admin');
                    }
                };
                
                checkHash();
                window.addEventListener('hashchange', checkHash);
                return () => window.removeEventListener('hashchange', checkHash);
            }, []);

            const switchToView = (view) => {
                if (view === 'participant') {
                    window.location.hash = 'participant';
                } else if (view === 'thank-you') {
                    window.location.hash = 'thank-you';
                } else {
                    window.location.hash = '';
                }
                setCurrentView(view);
            };

            const copyParticipantLink = () => {
                const participantUrl = `${window.location.origin}${window.location.pathname}#participant`;
                navigator.clipboard.writeText(participantUrl);
                alert('Participant link copied to clipboard!');
            };

            const saveWorkshopConfig = async () => {
                const config = {
                    type: 'config',
                    description: workshopDescription,
                    timeSlots: timeSlots
                };
                
                console.log('Saving workshop config:', config);
                console.log('Number of time slots:', timeSlots.length);
                
                await saveToSheets(config);
            };

            const confirmAvailability = async () => {
                if (participantName && participants[participantName]?.length > 0) {
                    setSaving(true);
                    try {
                        await saveToSheets({
                            type: 'participant',
                            name: participantName,
                            selectedSlots: participants[participantName]
                        });
                        
                        switchToView('thank-you');
                    } catch (error) {
                        alert('Error saving your response. Please try again.');
                        console.error('Save error:', error);
                    } finally {
                        setSaving(false);
                    }
                }
            };

            const addTimeSlot = async () => {
                if (newSlot.startDate && newSlot.endDate && workshopDescription) {
                    const slot = {
                        id: Date.now(),
                        dateFrom: newSlot.startDate,
                        dateTo: newSlot.endDate,
                        description: workshopDescription,
                        dateFromObj: new Date(newSlot.startDate),
                        dateToObj: new Date(newSlot.endDate)
                    };
                    const updatedSlots = [...timeSlots, slot];
                    setTimeSlots(updatedSlots);
                    setNewSlot({ startDate: '', endDate: '' });
                    
                    // Save to Google Sheets
                    try {
                        console.log('Saving workshop config...');
                        await saveWorkshopConfig();
                        console.log('Workshop config saved successfully');
                    } catch (error) {
                        console.error('Error saving workshop config:', error);
                        alert('Error saving time slot: ' + error.message + '\n\nPlease check:\n1. Your Google Apps Script URL is correct\n2. The script is deployed properly\n3. Check browser console for details');
                        // Remove the slot from local state since save failed
                        setTimeSlots(timeSlots);
                    }
                }
            };

            const removeTimeSlot = async (id) => {
                const updatedSlots = timeSlots.filter(slot => slot.id !== id);
                setTimeSlots(updatedSlots);
                
                const updatedParticipants = {};
                Object.keys(participants).forEach(name => {
                    updatedParticipants[name] = participants[name].filter(slotId => slotId !== id);
                });
                setParticipants(updatedParticipants);
                
                // Save to Google Sheets
                try {
                    await saveWorkshopConfig();
                } catch (error) {
                    console.error('Error saving workshop config:', error);
                }
            };

            const toggleAvailability = (slotId) => {
                if (!participantName) return;
                
                const currentAvailability = participants[participantName] || [];
                let updatedAvailability;
                
                if (currentAvailability.includes(slotId)) {
                    updatedAvailability = currentAvailability.filter(id => id !== slotId);
                } else {
                    updatedAvailability = [...currentAvailability, slotId];
                }
                
                setParticipants({
                    ...participants,
                    [participantName]: updatedAvailability
                });
            };

            const getSlotParticipantCount = (slotId) => {
                return Object.values(participants).filter(availability => 
                    availability.includes(slotId)
                ).length;
            };

            const getSlotParticipants = (slotId) => {
                return Object.keys(participants).filter(name => 
                    participants[name].includes(slotId)
                );
            };

            const sortedSlotsByPopularity = [...timeSlots].sort((a, b) => {
                const countA = getSlotParticipantCount(a.id);
                const countB = getSlotParticipantCount(b.id);
                if (countA !== countB) return countB - countA;
                return a.dateFromObj - b.dateFromObj;
            });

            const formatDateRange = (dateFrom, dateTo) => {
                const startDate = new Date(dateFrom);
                const endDate = new Date(dateTo);
                
                const formatOptions = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                };
                
                if (dateFrom === dateTo) {
                    return startDate.toLocaleDateString('en-US', formatOptions);
                } else {
                    return `${startDate.toLocaleDateString('en-US', formatOptions)} - ${endDate.toLocaleDateString('en-US', formatOptions)}`;
                }
            };

            const formatDateRangeDisplay = () => {
                if (!newSlot.startDate) return 'Select date range';
                
                const startDate = new Date(newSlot.startDate);
                const endDate = new Date(newSlot.endDate);
                
                if (newSlot.startDate === newSlot.endDate) {
                    return startDate.toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                } else {
                    return `${startDate.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric' 
                    })} - ${endDate.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric',
                        year: 'numeric' 
                    })}`;
                }
            };

            const handleDateRangeSelect = () => {
                setShowDatePicker(false);
            };

            const openGoogleSheet = () => {
                // Your Google Sheet URL
                const spreadsheetUrl = 'https://docs.google.com/spreadsheets/d/1qRAhPCd39aHXP6Ju25_JQNHWP9QBPyn8zB80x2GDk40/edit?gid=343624849#gid=343624849';
                window.open(spreadsheetUrl, '_blank');
            };

            const totalParticipants = Object.keys(participants).length;
            const maxAvailability = Math.max(...timeSlots.map(slot => getSlotParticipantCount(slot.id)), 0);

            if (loading) {
                return (
                    <div className="max-w-4xl mx-auto p-6 bg-white min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto mb-4"></div>
                            <p className="text-gray-600">Loading workshop data from Google Sheets...</p>
                        </div>
                    </div>
                );
            }

            if (currentView === 'thank-you') {
                // Load fresh data when showing results
                const [resultsData, setResultsData] = useState({ timeSlots: [], participants: {} });
                const [loadingResults, setLoadingResults] = useState(true);

                useEffect(() => {
                    const loadResultsData = async () => {
                        try {
                            const data = await loadFromSheets();
                            setResultsData({
                                timeSlots: data.config.timeSlots || [],
                                participants: data.participants || {}
                            });
                        } catch (error) {
                            console.error('Error loading results:', error);
                        } finally {
                            setLoadingResults(false);
                        }
                    };
                    loadResultsData();
                }, []);

                const getResultsSlotParticipantCount = (slotId) => {
                    return Object.values(resultsData.participants).filter(availability => 
                        availability.includes(slotId)
                    ).length;
                };

                const sortedResultsByPopularity = [...resultsData.timeSlots].sort((a, b) => {
                    const countA = getResultsSlotParticipantCount(a.id);
                    const countB = getResultsSlotParticipantCount(b.id);
                    if (countA !== countB) return countB - countA;
                    return a.dateFromObj - b.dateFromObj;
                });

                const totalResultsParticipants = Object.keys(resultsData.participants).length;
                const maxResultsAvailability = Math.max(...resultsData.timeSlots.map(slot => getResultsSlotParticipantCount(slot.id)), 0);

                return (
                    <div className="max-w-4xl mx-auto p-6 bg-white min-h-screen">
                        <div className="text-center mb-8">
                            <div className="mb-6">
                                <CheckCircle className="icon-3xl text-green-600 mx-auto mb-4" />
                                <h1 className="text-4xl font-bold text-gray-900 mb-2">Thank You for Your Vote!</h1>
                                <p className="text-xl text-gray-600 mb-6">Your availability has been successfully saved to Google Sheets.</p>
                            </div>
                            
                            <div className="bg-green-50 border border-green-200 rounded-lg p-6 mb-6 max-w-md mx-auto">
                                <h3 className="font-semibold text-green-800 mb-2">What's Next?</h3>
                                <p className="text-green-700 text-sm">
                                    The workshop organizer will review all responses and announce the final dates soon. 
                                    Check out the current results below!
                                </p>
                            </div>
                        </div>

                        {loadingResults ? (
                            <div className="text-center">
                                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                                <p className="text-gray-600">Loading current results...</p>
                            </div>
                        ) : resultsData.timeSlots.length > 0 && totalResultsParticipants > 0 ? (
                            <div className="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                                <div className="flex items-center gap-2 mb-4">
                                    <Users className="icon-2xl text-blue-600" />
                                    <h3 className="text-xl font-semibold">Current Results</h3>
                                    <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm font-medium">
                                        {totalResultsParticipants} vote{totalResultsParticipants !== 1 ? 's' : ''} so far
                                    </span>
                                </div>
                                
                                <div className="space-y-4">
                                    {sortedResultsByPopularity.map((slot, index) => {
                                        const count = getResultsSlotParticipantCount(slot.id);
                                        const percentage = totalResultsParticipants > 0 ? (count / totalResultsParticipants) * 100 : 0;
                                        const formattedDate = formatDateRange(slot.dateFrom, slot.dateTo);
                                        const isWinner = count === maxResultsAvailability && count > 0;
                                        const rank = index + 1;
                                        
                                        return (
                                            <div key={slot.id} className={`p-4 rounded-lg border-2 ${isWinner ? 'border-green-500 bg-green-50' : 'border-gray-200 bg-white'}`}>
                                                <div className="flex items-center justify-between mb-2">
                                                    <div className="flex items-center gap-3">
                                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-white ${
                                                            rank === 1 ? 'bg-yellow-500' : 
                                                            rank === 2 ? 'bg-gray-400' : 
                                                            rank === 3 ? 'bg-orange-400' : 'bg-gray-300'
                                                        }`}>
                                                            {rank}
                                                        </div>
                                                        {isWinner && <CheckCircle className="icon-lg text-green-600" />}
                                                        <div>
                                                            <div className={`font-semibold text-lg ${isWinner ? 'text-green-700' : 'text-gray-900'}`}>
                                                                {slot.description}
                                                            </div>
                                                            <div className="text-gray-600">{formattedDate}</div>
                                                        </div>
                                                    </div>
                                                    <div className="text-right">
                                                        <div className={`text-2xl font-bold ${isWinner ? 'text-green-600' : 'text-gray-900'}`}>
                                                            {count}/{totalResultsParticipants}
                                                        </div>
                                                        <div className="text-sm text-gray-500">{Math.round(percentage)}% available</div>
                                                    </div>
                                                </div>
                                                
                                                <div className="w-full bg-gray-200 rounded-full h-3">
                                                    <div 
                                                        className={`h-3 rounded-full ${
                                                            rank === 1 ? 'bg-yellow-500' : 
                                                            rank === 2 ? 'bg-gray-400' : 
                                                            rank === 3 ? 'bg-orange-400' : 'bg-gray-300'
                                                        } ${isWinner ? 'bg-green-500' : ''}`}
                                                        style={{ width: `${percentage}%` }}
                                                    ></div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>

                                {maxResultsAvailability > 0 && (
                                    <div className="mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                                        <h4 className="font-semibold text-green-800 mb-2">
                                            🏆 Current Winner{sortedResultsByPopularity.filter(slot => getResultsSlotParticipantCount(slot.id) === maxResultsAvailability).length > 1 ? 's' : ''}:
                                        </h4>
                                        <div className="space-y-1">
                                            {sortedResultsByPopularity
                                                .filter(slot => getResultsSlotParticipantCount(slot.id) === maxResultsAvailability)
                                                .map(slot => {
                                                    const formattedDate = formatDateRange(slot.dateFrom, slot.dateTo);
                                                    return (
                                                        <div key={slot.id} className="text-green-700 font-medium">
                                                            {slot.description} - {formattedDate}
                                                        </div>
                                                    );
                                                })}
                                        </div>
                                    </div>
                                )}

                                <div className="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                    <p className="text-sm text-blue-700">
                                        <strong>Note:</strong> Results update in real-time as more team members vote. 
                                        The final decision will be announced once everyone has responded.
                                    </p>
                                </div>
                            </div>
                        ) : (
                            <div className="text-center py-8 bg-gray-50 rounded-lg">
                                <p className="text-gray-600">No results to display yet. More votes needed!</p>
                            </div>
                        )}

                        <div className="text-center space-y-3">
                            <button
                                onClick={() => switchToView('participant')}
                                className="block w-full max-w-sm mx-auto px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                            >
                                View/Edit My Response
                            </button>
                            
                            <button
                                onClick={() => switchToView('admin')}
                                className="block w-full max-w-sm mx-auto px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
                            >
                                View Full Results (Admin)
                            </button>
                        </div>
                    </div>
                );
            }

            if (currentView === 'admin') {
                return (
                    <div className="max-w-4xl mx-auto p-6 bg-white">
                        <div className="flex items-center justify-between mb-6">
                            <div className="flex items-center gap-3">
                                <Calendar className="icon-xl text-blue-600" />
                                <h1 className="text-3xl font-bold text-gray-900">Workshop Scheduler</h1>
                                <span className="bg-green-100 text-green-600 px-2 py-1 rounded text-sm">Google Sheets</span>
                            </div>
                            <div className="flex gap-2">
                                <button
                                    onClick={openGoogleSheet}
                                    className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                                >
                                    📊 Open Google Sheet
                                </button>
                                <button
                                    onClick={copyParticipantLink}
                                    className="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
                                >
                                    <Link className="icon" />
                                    Copy Participant Link
                                </button>
                                <button
                                    onClick={() => switchToView('participant')}
                                    className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                >
                                    <User className="icon" />
                                    Participant View
                                </button>
                            </div>
                        </div>

                        <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                            <div className="flex items-center gap-2 mb-2">
                                <Settings className="icon-lg text-green-600" />
                                <h2 className="text-lg font-semibold text-green-900">Admin Panel</h2>
                                <Save className="icon text-green-600" />
                            </div>
                            <p className="text-green-700">All data is automatically saved to your Google Sheet. Participant responses appear in real-time in the "Responses" tab.</p>
                            
                            <div className="mt-3 p-3 bg-green-100 rounded-lg">
                                <p className="text-sm text-green-800">
                                    <strong>Share with participants:</strong> Send them the participant link using the "Copy Participant Link" button above.
                                </p>
                            </div>
                            
                            <div className="mt-3 p-3 bg-yellow-100 border border-yellow-300 rounded-lg">
                                <p className="text-sm text-yellow-800">
                                    <strong>🔧 Debug Tools:</strong> If you get errors, open browser console (F12) and run:<br/>
                                    <code className="bg-yellow-200 px-1 rounded">debugWorkshopScheduler.testConnection()</code>
                                </p>
                            </div>
                        </div>

                        <div className="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                            <h3 className="text-lg font-semibold mb-4">Workshop Details</h3>
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-2">Workshop Description</label>
                                <input
                                    type="text"
                                    placeholder="e.g., Sprint Planning Workshop"
                                    value={workshopDescription}
                                    onChange={(e) => setWorkshopDescription(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                />
                                <p className="text-sm text-gray-500 mt-1">All time slots will be added under this workshop description.</p>
                            </div>
                            
                            <h4 className="text-md font-medium mb-3">Add Time Slots</h4>
                            <div className="space-y-4">
                                <div className="relative">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                                    <div 
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500 cursor-pointer bg-white flex items-center justify-between"
                                        onClick={() => setShowDatePicker(!showDatePicker)}
                                    >
                                        <span className={`${!newSlot.startDate ? 'text-gray-500' : 'text-gray-900'}`}>
                                            {formatDateRangeDisplay()}
                                        </span>
                                        <Calendar className="icon-lg text-gray-400" />
                                    </div>
                                    
                                    {showDatePicker && (
                                        <div className="absolute top-full left-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-10 p-4 min-w-full">
                                            <div className="space-y-3">
                                                <div>
                                                    <label className="block text-xs font-medium text-gray-600 mb-1">Start Date</label>
                                                    <input
                                                        type="date"
                                                        value={newSlot.startDate}
                                                        onChange={(e) => setNewSlot({...newSlot, startDate: e.target.value, endDate: e.target.value})}
                                                        className="w-full px-2 py-1 border border-gray-200 rounded text-sm"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-medium text-gray-600 mb-1">End Date</label>
                                                    <input
                                                        type="date"
                                                        value={newSlot.endDate}
                                                        onChange={(e) => setNewSlot({...newSlot, endDate: e.target.value})}
                                                        min={newSlot.startDate}
                                                        className="w-full px-2 py-1 border border-gray-200 rounded text-sm"
                                                    />
                                                </div>
                                                <div className="flex gap-2 pt-2">
                                                    <button
                                                        type="button"
                                                        onClick={handleDateRangeSelect}
                                                        disabled={!newSlot.startDate || !newSlot.endDate}
                                                        className="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 disabled:bg-gray-300"
                                                    >
                                                        Apply
                                                    </button>
                                                    <button
                                                        type="button"
                                                        onClick={() => setShowDatePicker(false)}
                                                        className="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300"
                                                    >
                                                        Cancel
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                
                                <button
                                    onClick={addTimeSlot}
                                    disabled={!workshopDescription || !newSlot.startDate || !newSlot.endDate}
                                    className="flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                                >
                                    <Plus className="icon" />
                                    Add Time Slot & Save
                                </button>
                            </div>
                        </div>

                        {timeSlots.length > 0 && (
                            <div className="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                                <h3 className="text-lg font-semibold mb-2">{workshopDescription}</h3>
                                <p className="text-sm text-gray-600 mb-4">Available time slots for this workshop:</p>
                                <div className="space-y-3">
                                    {timeSlots.map((slot) => {
                                        const formattedDate = formatDateRange(slot.dateFrom, slot.dateTo);
                                        return (
                                            <div key={slot.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                <div className="flex items-center gap-3">
                                                    <Clock className="icon-lg text-gray-500" />
                                                    <div>
                                                        <div className="font-medium">{formattedDate}</div>
                                                    </div>
                                                </div>
                                                <button
                                                    onClick={() => removeTimeSlot(slot.id)}
                                                    className="text-red-600 hover:text-red-800 p-1"
                                                >
                                                    <Trash2 className="icon" />
                                                </button>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {timeSlots.length > 0 && totalParticipants > 0 && (
                            <div className="bg-white border border-gray-200 rounded-lg p-6">
                                <div className="flex items-center gap-2 mb-4">
                                    <Users className="icon-2xl text-green-600" />
                                    <h3 className="text-xl font-semibold">Results Analysis</h3>
                                    <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm font-medium">
                                        {totalParticipants} participant{totalParticipants !== 1 ? 's' : ''}
                                    </span>
                                    <span className="bg-green-100 text-green-800 px-2 py-1 rounded-full text-sm font-medium">
                                        Synced with Sheets
                                    </span>
                                </div>
                                
                                <div className="space-y-4">
                                    {sortedSlotsByPopularity.map((slot) => {
                                        const count = getSlotParticipantCount(slot.id);
                                        const slotParticipants = getSlotParticipants(slot.id);
                                        const percentage = totalParticipants > 0 ? (count / totalParticipants) * 100 : 0;
                                        const formattedDate = formatDateRange(slot.dateFrom, slot.dateTo);
                                        const isWinner = count === maxAvailability && count > 0;
                                        
                                        return (
                                            <div key={slot.id} className={`p-4 rounded-lg border-2 ${isWinner ? 'border-green-500 bg-green-50' : 'border-gray-200 bg-white'}`}>
                                                <div className="flex items-start justify-between mb-2">
                                                    <div className="flex items-center gap-2">
                                                        {isWinner && <CheckCircle className="icon-lg text-green-600" />}
                                                        <div>
                                                            <div className="font-semibold text-lg">{slot.description}</div>
                                                            <div className="text-gray-600">{formattedDate}</div>
                                                        </div>
                                                    </div>
                                                    <div className="text-right">
                                                        <div className={`text-2xl font-bold ${isWinner ? 'text-green-600' : 'text-gray-900'}`}>
                                                            {count}/{totalParticipants}
                                                        </div>
                                                        <div className="text-sm text-gray-500">{Math.round(percentage)}% available</div>
                                                    </div>
                                                </div>
                                                
                                                <div className="w-full bg-gray-200 rounded-full h-2 mb-3">
                                                    <div 
                                                        className={`h-2 rounded-full ${isWinner ? 'bg-green-500' : 'bg-blue-500'}`}
                                                        style={{ width: `${percentage}%` }}
                                                    ></div>
                                                </div>
                                                
                                                {slotParticipants.length > 0 && (
                                                    <div className="flex flex-wrap gap-2">
                                                        {slotParticipants.map((name) => (
                                                            <span key={name} className="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm">
                                                                {name}
                                                            </span>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>

                                {maxAvailability > 0 && (
                                    <div className="mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                                        <h4 className="font-semibold text-green-800 mb-2">🏆 Winner Date{sortedSlotsByPopularity.filter(slot => getSlotParticipantCount(slot.id) === maxAvailability).length > 1 ? 's' : ''}:</h4>
                                        <div className="space-y-1">
                                            {sortedSlotsByPopularity
                                                .filter(slot => getSlotParticipantCount(slot.id) === maxAvailability)
                                                .map(slot => {
                                                    const formattedDate = formatDateRange(slot.dateFrom, slot.dateTo);
                                                    return (
                                                        <div key={slot.id} className="text-green-700 font-medium">
                                                            {slot.description} - {formattedDate}
                                                        </div>
                                                    );
                                                })}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {timeSlots.length === 0 && (
                            <div className="text-center py-12 bg-gray-50 rounded-lg">
                                <Calendar className="icon-3xl text-gray-400 mx-auto mb-4" />
                                <h3 className="text-lg font-medium text-gray-900 mb-2">No Time Slots Yet</h3>
                                <p className="text-gray-600">Add your first workshop time slot to get started.</p>
                            </div>
                        )}
                    </div>
                );
            }

            return (
                <div className="max-w-4xl mx-auto p-6 bg-white">
                    <div className="flex items-center justify-between mb-6">
                        <div className="flex items-center gap-3">
                            <Users className="icon-xl text-green-600" />
                            <h1 className="text-3xl font-bold text-gray-900">Select Your Availability</h1>
                        </div>
                        <button
                            onClick={() => switchToView('admin')}
                            className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                        >
                            <Settings className="icon" />
                            Admin View
                        </button>
                    </div>

                    <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                        <div className="mb-3">
                            <label className="block text-sm font-medium text-green-900 mb-2">Your Name</label>
                            <input
                                type="text"
                                placeholder="Enter your name"
                                value={participantName}
                                onChange={(e) => setParticipantName(e.target.value)}
                                className="w-full max-w-sm px-3 py-2 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                            />
                        </div>
                        <p className="text-green-700">Select all the time slots where you're available for the workshop, then confirm your availability. Your response will be automatically saved to Google Sheets.</p>
                    </div>

                    {timeSlots.length === 0 ? (
                        <div className="text-center py-12 bg-gray-50 rounded-lg">
                            <Calendar className="icon-3xl text-gray-400 mx-auto mb-4" />
                            <h3 className="text-lg font-medium text-gray-900 mb-2">No Time Slots Available</h3>
                            <p className="text-gray-600">The administrator hasn't added any workshop time slots yet.</p>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {timeSlots.map((slot) => {
                                const formattedDate = formatDateRange(slot.dateFrom, slot.dateTo);
                                const isSelected = participantName && participants[participantName]?.includes(slot.id);
                                const participantCount = getSlotParticipantCount(slot.id);
                                
                                return (
                                    <div 
                                        key={slot.id} 
                                        className={`p-4 rounded-lg border-2 cursor-pointer transition-all ${
                                            isSelected 
                                                ? 'border-green-500 bg-green-50' 
                                                : 'border-gray-200 bg-white hover:border-gray-300'
                                        } ${!participantName ? 'opacity-50 cursor-not-allowed' : ''}`}
                                        onClick={() => toggleAvailability(slot.id)}
                                    >
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${
                                                    isSelected ? 'border-green-500 bg-green-500' : 'border-gray-300'
                                                }`}>
                                                    {isSelected && <CheckCircle className="icon text-white" />}
                                                </div>
                                                <div>
                                                    <div className="font-semibold text-lg">{slot.description}</div>
                                                    <div className="text-gray-600">{formattedDate}</div>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-sm text-gray-500">
                                                    {participantCount} participant{participantCount !== 1 ? 's' : ''} available
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {participantName && participants[participantName]?.length > 0 && (
                        <div className="mt-6 space-y-4">
                            <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <h4 className="font-semibold text-blue-800 mb-2">Your Selected Time Slots:</h4>
                                <div className="space-y-1">
                                    {timeSlots
                                        .filter(slot => participants[participantName]?.includes(slot.id))
                                        .map(slot => {
                                            const formattedDate = formatDateRange(slot.dateFrom, slot.dateTo);
                                            return (
                                                <div key={slot.id} className="text-blue-700">
                                                    ✓ {slot.description} - {formattedDate}
                                                </div>
                                            );
                                        })}
                                </div>
                            </div>
                            
                            <div className="flex justify-center">
                                <button
                                    onClick={confirmAvailability}
                                    disabled={saving}
                                    className="px-8 py-3 bg-green-600 text-white text-lg font-semibold rounded-lg hover:bg-green-700 transition-colors shadow-lg disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center gap-2"
                                >
                                    {saving ? (
                                        <>
                                            <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                                            Saving to Google Sheets...
                                        </>
                                    ) : (
                                        <>
                                            <Save className="icon" />
                                            Confirm My Availability
                                        </>
                                    )}
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<WorkshopScheduler />, document.getElementById('root'));
    </script>
</body>
</html>
